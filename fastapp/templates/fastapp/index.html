<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    {% block extra_header_pre %}
    {% endblock %}

    {% block fastapp_title %}
    <title>Fastapp {% if FASTAPP_NAME %}: {{ FASTAPP_NAME }} {% endif %}</title>
    {% endblock fastapp_title %}

    {% block fastapp_header %}
    <!-- Bootstrap core CSS -->
    <link href="{{ STATIC_URL }}bare/css/bootstrap.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>

    <!-- js -->
    <script src="{{ STATIC_URL }}js/ndatetime-1.4.0.min.js"></script>

    <!-- Pusher -->
    <script src="https://d3dy5gmtp8yhk7.cloudfront.net/2.1/pusher.min.js" type="text/javascript"></script>

    <!-- css for fastapp -->
    <link href="{{ STATIC_URL }}css/fastapp.css" rel="stylesheet">
    {% if "full" not in request.GET %}
    <link href="{{ STATIC_URL }}css/fastapp-nav.css" rel="stylesheet">
    {% endif %}
    
    <!-- js for fastapp -->
    <script type="text/javascript"> 
    window.username = "{{ user.username }}"; 
    window.pusher_key = "{{ PUSHER_KEY }}";
    window.shared_key_link = "{{ active_base.shared }}"
    window.active_base = "{{ active_base.name }}"
    </script>
    <script src="{{ STATIC_URL }}js/fastapp.js"></script>

    <!-- CodeMirror -->
    <script src="{{ STATIC_URL }}codemirror/js/codemirror.js"></script>
    <link rel="stylesheet" href="{{ STATIC_URL }}codemirror/css/codemirror.css">
    <script src="{{ STATIC_URL}}codemirror/js/javascript.js"></script>
    <script src="{{ STATIC_URL}}codemirror/js/python.js"></script>
    <script src="{{ STATIC_URL}}codemirror/js/xml.js"></script>
    <script src="{{ STATIC_URL}}codemirror/js/css.js"></script>
    <script src="{{ STATIC_URL}}codemirror/js/htmlmixed.js"></script>
    <script src="{{ STATIC_URL}}codemirror/js/htmlembedded.js"></script>
    <script src="{{ STATIC_URL}}codemirror/js/vim.js"></script>
    {% endblock fastapp_header %}

    {% block extra_header %}
    {% endblock %}

</head>

<body>

    {% block fastapp_nav %}
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <a href="https://github.com/fatrix/django-fastapp"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/fastapp/">Fastapp</a>
                <a class="navbar-brand"><small>version {{ VERSION }}</small></a>
            </div>

            <div class="collapse navbar-collapse navbar-ex1-collapse">
                {% if user.is_authenticated %}
                <ul class="nav navbar-nav navbar-right pull-left">
                    <li><a href=".?refresh">Refresh</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">My Bases<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            {% for base in bases %}
                            <li><a class="{% ifequal active_base base %}active{%endifequal%}"
                             href="/fastapp/{{ base.name }}/index/">{{ base.name }}</a></li>
                             {% endfor %}
                         </ul>
                     </li>
                 </ul>
                 {% endif %}
                 {% if not user.is_authenticated %}
                 <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Shared Bases<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            {% for name, shared_key in shared_bases.items %}
                            <li><a class="{% ifequal active_base base %}active{%endifequal%}"
                             href="/fastapp/{{ name }}/index/?shared_key={{ shared_key }}">{{ name }}</a></li>
                             {% endfor %}
                         </ul>
                     </li>
                 </ul>
                 {% endif %}
             </div>
         </div>
     </nav>
     {% endblock %}


     {% block fastapp_main %}
     <!-- /.container -->
     <div class="container">

        <div class="span4">
            <h3>Client</h3>
        </div>
        <div class="span4">
            <h3>Server</h3>
        </div>
    </div>

    <div class="container">

        <div class="row">
            <div class="col-lg-12">
                {% if FASTAPP_NAME %}
                <h1>{{ FASTAPP_NAME }} 
                    {# Logic for authenticated user (owner) #}
                    <script>
                //window.readOnly = {{ user.is_authenticated }};
                </script>

                {% if user.is_authenticated %}
                <button id="share" type="button" class="btn btn-default btn-xs">
                    <span class="glyphicon glyphicon-share"></span> Share</button>
                    {% endif %}
                </h1>
                <h2>index
                    <button id="edit_html" type="button" class="btn btn-default btn-xs">
                        <span class="glyphicon glyphicon-edit"></span> Edit</button>
                    </h2>
                    <p>
                        <form id="edit_html"><textarea id="area_html" name="html">{{ active_base.content }}</textarea></form>
                    </p>
                </p>

                <script>
                /* html */
                var editor = CodeMirror.fromTextArea(document.getElementById("area_html"), {
                    lineNumbers: true,
                    mode: "application/x-ejs",
                    indentUnit: 4,
                    indentWithTabs: true,
                    enterMode: "keep",
                    vimMode: true,
                    tabMode: "shift",
                });
                editor.on("blur", function(cm, cmChangeObject){
                    $.post("/fastapp/{{ active_base.name }}/sync/", {
                        content: cm.getValue()
                    })
                });
                </script>


                {% for exec in FASTAPP_EXECS %}
                <h2>{{ exec.name }}
                    <button id="edit_exec_{{ exec.name }}" type="button" class="btn btn-default btn-xs">
                        <span class="glyphicon glyphicon-edit"></span> Edit</button>
                </h2>
                <p><a class="exec" href="/fastapp/{{active_base.name}}/exec/{{exec.name}}/?json">/fastapp/{{active_base.name}}/exec/{{exec.name}}/?json</a></p>
                <p>
                    <form id="edit_exec_{{ exec.name}}" class="code">
                        <textarea id="exec_code_for_{{ exec.name }}" name="exec_code_for_{{ exec.name }}">{{ exec.module }}</textarea>
                    </form>
                </p>

                <script>
                /* code */
                editor = CodeMirror.fromTextArea(document.getElementById("exec_code_for_{{ exec.name }}"), {
                    mode: {name: "text/x-cython",
                    version: 2,
                    singleLineStringErrors: false},
                    //readOnly: "$window.readyOnly",
                    lineNumbers: true,
                    indentUnit: 4,
                    tabMode: "shift",
                    indentWithTabs: true,
                    matchBrackets: true,
                    vimMode: true,
                    showCursorWhenSelecting: true
                });
                editor.on("blur", function(cm, cmChangeObject){
                    $.post("/fastapp/{{ active_base.name }}/sync/", {
                        content: cm.getValue(),
                        exec_name: "{{ exec.name }}"
                    })
                });
                </script>

            </li>
            {% endfor %}
            {% endif %}

            {% if LAST_EXEC %}
            <h3>{{ LAST_EXEC }}</h3>
            {% endif %}

            {% for message in messages %}
            <div class="alert {{ message.tags }}">{{ message|safe }}</div>
            {% endfor %}
            <div id="messages">
            </div>
    {% endblock fastapp_main %}
    {% block content %}
    {% endblock %}

        </div>
    </div>
</div>
<!-- /.container -->

<!-- JavaScript -->
<script src="{{ STATIC_URL }}bare/js/bootstrap.js"></script>


</body>
</html>
